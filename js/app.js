define(["components/mvc","components/react","components/react-dom"],function(e,t,n){"use strict";t="default"in t?t["default"]:t,n="default"in n?n["default"]:n;var r={};r.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r.createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),r.inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},r.possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},r.slicedToArray=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(c){i=!0,o=c}finally{try{!r&&a["return"]&&a["return"]()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();var i=function(e){function n(t){r.classCallCheck(this,n);var i=r.possibleConstructorReturn(this,e.call(this,t));return i.foxbox=t.foxbox,i}return r.inherits(n,e),n.prototype.shouldComponentUpdate=function(){return!1},n.prototype.handleOnClick=function(){this.foxbox.logout()},n.prototype.render=function(){var e=location.hash.substr(1).split("/").shift(),n=[{id:"services",label:"Home"},{id:"themes",label:"Themes"},{id:"mr-fox",label:"Mr. Fox"}].map(function(n){var r="navigation-menu__item";return e===n.id&&(r+=" navigation-menu__item--active"),t.createElement("li",{key:n.id,className:r},t.createElement("a",{href:`#${n.id}`,className:"navigation-menu__item-link"},n.label))});return t.createElement("ul",{className:"navigation-menu"},n,t.createElement("li",{className:"navigation-menu__item"},t.createElement("a",{href:"#users/login",className:"navigation-menu__item-link user-logout-button",onClick:this.handleOnClick.bind(this)},"Log out")))},n}(t.Component);i.propTypes={foxbox:t.PropTypes.object.isRequired};var o=function(e){function n(){return r.classCallCheck(this,n),r.possibleConstructorReturn(this,e.apply(this,arguments))}return r.inherits(n,e),n.prototype.renderHeader=function(e,n){var r="app-view__header";return n&&(r+=` ${n}`),t.createElement("header",{className:r},t.createElement("h1",null,e))},n.prototype.renderFooter=function(){return t.createElement("footer",{className:"app-view__footer"},t.createElement(i,{foxbox:this.props.foxbox}))},n.prototype.renderBody=function(){return null},n.prototype.render=function(){return t.createElement("div",{className:"app-view"},this.renderHeader(),t.createElement("section",{className:"app-view__body"},this.renderBody()),this.renderFooter())},n}(t.Component);o.propTypes={foxbox:t.PropTypes.object.isRequired};var s=function(e){function n(t){r.classCallCheck(this,n);var i=r.possibleConstructorReturn(this,e.call(this,t));return i.state={boxes:t.foxbox.boxes,selectedBox:null,loginEnabled:t.foxbox.online},i.foxbox=t.foxbox,i.onBoxOnline=i.onBoxOnline.bind(i),i.onBoxDiscovery=i.onBoxDiscovery.bind(i),i.onSelectChange=i.onSelectChange.bind(i),i.onFormSubmit=i.onFormSubmit.bind(i),i}return r.inherits(n,e),n.prototype.componentDidMount=function(){this.foxbox.addEventListener("online",this.onBoxOnline),this.foxbox.addEventListener("discovery",this.onBoxDiscovery)},n.prototype.componentWillUnmount=function(){this.foxbox.removeEventListener("online",this.onBoxOnline),this.foxbox.removeEventListener("discovery",this.onBoxDiscovery)},n.prototype.onSelectChange=function(e){var t=e.target.selectedIndex;this.setState({selectedBox:t}),this.foxbox.selectBox(t)},n.prototype.onFormSubmit=function(e){e.preventDefault(),this.foxbox.login()},n.prototype.onBoxOnline=function(e){this.setState({loginEnabled:e})},n.prototype.onBoxDiscovery=function(){this.setState({boxes:this.foxbox.boxes})},n.prototype.renderHeader=function(){return e.prototype.renderHeader.call(this,"Project Link","app-view__header--white")},n.prototype.renderFooter=function(){return null},n.prototype.renderBody=function(){var e=this,n=null;if(this.state.boxes.length>1){var r=this.state.selectedBox||0,i=this.state.boxes.map(function(n,i){return n.client===e.foxbox.client&&(r=i),t.createElement("option",{key:n.client,value:i},n.client)});n=t.createElement("select",{className:"user-login__box-selector",value:r,onChange:this.onSelectChange},i)}return t.createElement("form",{className:"app-view__fill-body user-login",onSubmit:this.onFormSubmit},t.createElement("img",{className:"user-login__logo",src:"img/icon.svg"}),n,t.createElement("button",{className:"user-login__login-button",disabled:!this.state.loginEnabled},"Connect to your box"))},n}(o);s.propTypes={foxbox:t.PropTypes.object.isRequired};var a=["login","logout"],c=a[0],l=function(e){function i(){return r.classCallCheck(this,i),r.possibleConstructorReturn(this,e.apply(this,arguments))}return r.inherits(i,e),i.prototype.main=function(){var e=arguments.length<=0||void 0===arguments[0]?c:arguments[0];switch(a.includes(e)||(console.error(`Bad users route: "${e}". Falling back to ${c}.`),e=c),e){case"login":this.login();break;case"logout":this.logout()}},i.prototype.login=function(){n.render(t.createElement(s,{foxbox:this.foxbox}),this.mountNode)},i.prototype.logout=function(){this.foxbox.logout(),location.hash="#users/login"},i}(e.Controller),u=function(e){function n(t){r.classCallCheck(this,n);var i=r.possibleConstructorReturn(this,e.call(this,t));return i.state={available:!1,on:!0,locked:!0,motionDetected:!1},i.service=t.service,i.foxbox=t.foxbox,i.onMotion=i.onMotion.bind(i),i}return r.inherits(n,e),n.prototype.componentDidMount=function(){var e=this;switch(this.service.type){case"light":this.service.isAvailable().then(function(t){e.setState({available:t})})["catch"](console.error.bind(console)),this.service.isOn().then(function(t){e.setState({on:t})})["catch"](console.error.bind(console));break;case"motion-sensor":this.service.isMotionDetected().then(this.onMotion),this.service.watch("motion",this.onMotion);break;case"door-lock":this.service.isLocked().then(function(t){e.setState({locked:t})})["catch"](function(e){console.error("Can not retrieve door lock status: %o",e)})}},n.prototype.componentWillUnmount=function(){switch(this.service.type){case"motion-sensor":this.service.unwatch("motion",this.onMotion)}},n.prototype.handleLightOnChange=function(e){var t=this,n=e.target.checked;this.setState({on:n}),this.service.turn(n)["catch"](function(e){t.setState({on:!n}),console.error(e)})},n.prototype.onDoorLockUnlock=function(e){var t=this,n=e.target.checked;this.setState({locked:n}),this.service.lockUnlock(n)["catch"](function(e){t.setState({locked:!n}),console.error("Could not change door lock status: %o",e)})},n.prototype.onMotion=function(e){this.setState({motionDetected:e})},n.prototype.getBulbColour=function(){var e=1,t=1,n=1,r=e,i=Math.round(100*t),o=n;return`hsla(${r},${i}%,50%,${o})`},n.prototype.renderLightService=function(){var e=this.state.available,n="Light",r="light";if(void 0!==this.service.model)switch(this.service.model){case"BSB002":r="bridge_v2";break;case"LCT001":case"LCT007":case"LCT010":case"LTW010":case"LWB004":case"LWB006":r="white_and_color_e27_b22";break;case"LWB010":case"LWB014":r="white_e27_b22";break;case"LCT002":case"LCT011":case"LTW011":case"LWB005":case"LWB011":r="br30";break;case"LCT003":r="gu10_par16";break;case"LST001":case"LST002":r="lightstrip";break;case"LLC006":case"LLC010":r="iris";break;case"LLC005":case"LLC011":case"LLC012":case"LLC007":r="bloom";break;case"LLC014":r="aura";break;case"LLC013":r="storylight";break;case"LLC020":r="go";break;case"HBL001":case"HBL002":case"HBL003":r="beyond_ceiling_pendant_table";break;case"HIL001":case"HIL002":r="impulse";break;case"HEL001":case"HEL002":r="entity";break;case"HML001":case"HML002":case"HML003":case"HML004":case"HML005":case"HML006":r="phoenix_ceiling_pendant_table_wall";break;case"HML007":r="phoenix_recessed_spot";break;case"SWT001":r="tap";break;case"RWL021":r="hds"}var i=this.getServiceName(),o=i?t.createElement("small",null,` (${i})`):null;return t.createElement("li",{className:"service-list__item","data-icon":r,"data-connected":e},t.createElement("a",{className:"service-list__item-link",href:`#services/${this.service.id}`},n,o),t.createElement("div",{className:"service-list__item-color-picker",style:{background:this.getBulbColour()}}),t.createElement("label",null,t.createElement("input",{className:"service-list__on-off-toggle",type:"checkbox",checked:this.state.on,disabled:!e,onChange:this.handleLightOnChange.bind(this)})))},n.prototype.renderDoorLock=function(){var e=this.getServiceName(),n=e?t.createElement("small",null,` (${e})`):null;return t.createElement("li",{className:"service-list__item","data-icon":"door-lock"},t.createElement("a",{className:"service-list__item-link",href:`#services/${this.service.id}`},"Door Lock",n),t.createElement("label",null,t.createElement("input",{className:"service-list__on-off-toggle",type:"checkbox",checked:this.state.locked,onChange:this.onDoorLockUnlock.bind(this)})))},n.prototype.renderMotionSensor=function(){var e=this.getServiceName(),n=e?t.createElement("small",null,` (${e})`):null,r="service-list__item motion-sensor-item";return this.state.motionDetected&&(r+=" motion-sensor-item--motion-detected"),t.createElement("li",{className:r},t.createElement("a",{className:"service-list__item-link",href:`#services/${this.service.id}`},"Motion Sensor",n))},n.prototype.renderGenericService=function(){var e=arguments.length<=0||void 0===arguments[0]?"Unknown service":arguments[0],n=arguments.length<=1||void 0===arguments[1]?"unknown":arguments[1],r=this.getServiceName(),i=r?t.createElement("small",null,` (${r})`):null;return t.createElement("li",{className:"service-list__item","data-icon":n,"data-connected":"true"},t.createElement("a",{className:"service-list__item-link",href:`#services/${this.service.id}`},e,i))},n.prototype.render=function(){switch(this.service.type){case"door-lock":return this.renderDoorLock();case"ip-camera":return this.renderGenericService("Camera","ip-camera");case"light":return this.renderLightService();case"motion-sensor":return this.renderMotionSensor();default:return this.renderGenericService()}},n.prototype.getServiceName=function(){return this.service.getTags().join(", ")||this.service.name},n}(t.Component);u.propTypes={foxbox:t.PropTypes.object.isRequired,service:t.PropTypes.object.isRequired};var h=function(e){function n(){return r.classCallCheck(this,n),r.possibleConstructorReturn(this,e.apply(this,arguments))}return r.inherits(n,e),n.prototype.render=function(){var e=this,n=this.props.services.filter(function(e){return"unknown"!==e.type}),r=n.map(function(n){return t.createElement(u,{key:n.id,service:n,foxbox:e.props.foxbox})});return t.createElement("ul",{className:"service-list"},r)},n}(t.Component);h.propTypes={foxbox:t.PropTypes.object.isRequired,services:t.PropTypes.array.isRequired};var p=function(e){function n(t){r.classCallCheck(this,n);var i=r.possibleConstructorReturn(this,e.call(this,t));return i.state={services:[],title:"",body:""},i.foxbox=t.foxbox,i.updateServiceList=i.updateServiceList.bind(i),i.updateServiceState=i.updateServiceState.bind(i),i}return r.inherits(n,e),n.prototype.componentDidMount=function(){this.updateServiceList(),this.foxbox.services.togglePolling(!0),this.foxbox.services.on("services-changed",this.updateServiceList),this.foxbox.services.on("service-changed",this.updateServiceState)},n.prototype.componentWillUnmount=function(){this.foxbox.services.togglePolling(!1),this.foxbox.services.off("services-changed",this.updateServiceList),this.foxbox.services.off("service-changed",this.updateServiceState)},n.prototype.updateServiceList=function(){var e=this;this.foxbox.services.getAll().then(function(t){return e.setState({services:t})})["catch"](function(e){console.error("Could not update service list: %o",e)})},n.prototype.updateServiceState=function(e){var t=this.state.services.findIndex(function(t){return t.id===e.id}),n=this.state.services;n[t]=e,this.setState({services:n})},n.prototype.renderHeader=function(){return e.prototype.renderHeader.call(this,"My Home")},n.prototype.renderBody=function(){return t.createElement("div",{className:"app-view__fill-body"},t.createElement("h2",null,"General"),t.createElement(h,{services:this.state.services,foxbox:this.foxbox}))},n}(o);p.propTypes={foxbox:t.PropTypes.object.isRequired};var d=function(e){function i(){return r.classCallCheck(this,i),r.possibleConstructorReturn(this,e.apply(this,arguments))}return r.inherits(i,e),i.prototype.main=function(){n.render(t.createElement(p,{foxbox:this.foxbox}),this.mountNode)},i}(e.Controller),f=function(e){function n(t){r.classCallCheck(this,n);var i=r.possibleConstructorReturn(this,e.call(this,t));return i.state={hasPreview:!1,hasPreviousSnapshot:!1},i.foxbox=t.foxbox,i.service=t.service,i}return r.inherits(n,e),n.prototype.takeSnapshot=function(){var e=this;this.service.takeSnapshot().then(function(t){var n=e.refs.snapshotPreview.src,r={hasPreview:!0,hasPreviousSnapshot:!1};e.refs.snapshotPreview.src=URL.createObjectURL(t),n&&(r.hasPreviousSnapshot=!0,e.refs.previousSnapshot.src&&URL.revokeObjectURL(e.refs.previousSnapshot.src),e.refs.previousSnapshot.src=n),e.setState(r)})["catch"](function(e){console.error("Error occurred while making a snapshot: ",e)})},n.prototype.render=function(){var e="app-view__fill-body camera-controls";return this.state.hasPreview&&(e+=" camera-controls--has-preview"),this.state.hasPreviousSnapshot&&(e+=" camera-controls--has-previous-snapshot"),t.createElement("div",{className:e},t.createElement("img",{ref:"snapshotPreview",alt:"Snapshot preview",className:"camera-controls__preview"}),t.createElement("div",{className:"camera-controls__empty-preview"},t.createElement("p",null,"Preview is not available."),t.createElement("p",null,"Touch button to take a snapshot!")),t.createElement("section",{className:"camera-controls__snapshot-tools"},t.createElement("button",{className:"camera-controls__snapshot-btn",type:"button",title:"Take a snapshot",onClick:this.takeSnapshot.bind(this)}),t.createElement("img",{ref:"previousSnapshot",className:"camera-controls__previous-snapshot"})))},n}(t.Component);f.propTypes={foxbox:t.PropTypes.object.isRequired,service:t.PropTypes.object.isRequired};var v=function(e){function n(t){r.classCallCheck(this,n);var i=r.possibleConstructorReturn(this,e.call(this,t));return i.state={name:t.service.name},i.foxbox=t.foxbox,i.service=t.service,i.onServiceStateChanged=i.onServiceStateChanged.bind(i),i}return r.inherits(n,e),n.prototype.componentDidMount=function(){this.foxbox.services.on("service-changed",this.onServiceStateChanged)},n.prototype.componentWillUnmount=function(){this.foxbox.services.off("service-changed",this.onServiceStateChanged)},n.prototype.onServiceStateChanged=function(e){e.id===this.service.id&&(this.service=e,this.setState({name:e.name}))},n.prototype.render=function(){return t.createElement("div",{className:"app-view__fill-body default-service__body"},t.createElement("p",{className:"default-service__notice"},"Oops, there are no settings available for this service."))},n}(t.Component);v.propTypes={foxbox:t.PropTypes.object.isRequired,service:t.PropTypes.object.isRequired};var g=function(e){function n(t){r.classCallCheck(this,n);var i=r.possibleConstructorReturn(this,e.call(this,t));return i.state={name:t.service.name},i.foxbox=t.foxbox,i.service=t.service,i.onServiceStateChanged=i.onServiceStateChanged.bind(i),i}return r.inherits(n,e),n.prototype.componentDidMount=function(){this.foxbox.services.on("service-changed",this.onServiceStateChanged)},n.prototype.componentWillUnmount=function(){this.foxbox.services.off("service-changed",this.onServiceStateChanged)},n.prototype.onServiceStateChanged=function(e){e.id===this.service.id&&(this.service=e,this.setState({name:e.name}))},n.prototype.render=function(){return t.createElement("div",{className:"app-view__fill-body default-service__body"},t.createElement("p",{className:"default-service__notice"},"Oops, there are no settings available for this service."))},n}(t.Component);g.propTypes={foxbox:t.PropTypes.object.isRequired,service:t.PropTypes.object.isRequired};var m=function(e){function n(t){r.classCallCheck(this,n);var i=r.possibleConstructorReturn(this,e.call(this,t));return i.state={service:null},i.foxbox=t.foxbox,i}return r.inherits(n,e),n.prototype.componentDidMount=function(){var e=this;this.foxbox.services.get(this.props.id).then(function(t){e.setState({service:t})})["catch"](function(e){console.error("Error occurred while retrieving service: ",e)})},n.prototype.renderHeader=function(){if(!this.state.service)return e.prototype.renderHeader.call(this,"Unknown Service");var n=this.state.service.name?this.state.service.name:"Unknown Service";return t.createElement("header",{className:"app-view__header"},t.createElement("h1",null,n),t.createElement("a",{href:`#services/${this.state.service.id}/tags`,title:"Edit tags",className:"service__edit-tags-link"},t.createElement("img",{className:"app-view__action-icon",src:"css/icons/tag.svg",alt:"Edit tags"})))},n.prototype.renderBody=function(){if(!this.state.service)return null;switch(this.state.service.type){case"ip-camera":return t.createElement(f,{service:this.state.service,foxbox:this.foxbox});case"light":return t.createElement(v,{service:this.state.service,foxbox:this.foxbox});default:return t.createElement(g,{service:this.state.service,foxbox:this.foxbox})}},n}(o);m.propTypes={foxbox:t.PropTypes.object.isRequired,id:t.PropTypes.string.isRequired};var b=function(e){function i(){return r.classCallCheck(this,i),r.possibleConstructorReturn(this,e.apply(this,arguments))}return r.inherits(i,e),i.prototype.main=function(e){n.render(t.createElement(m,{id:e,foxbox:this.foxbox}),this.mountNode)},i}(e.Controller),y=function(e){function n(){return r.classCallCheck(this,n),r.possibleConstructorReturn(this,e.apply(this,arguments))}return r.inherits(n,e),n.prototype.render=function(){var e=this,n=this.props.tags.map(function(n){return t.createElement("li",{key:n,className:"tag-list__item"},n,t.createElement("button",{className:"tag-list__item-remove",type:"button",onClick:e.props.onRemoveTag.bind(null,n),title:"Remove tag"}))});return t.createElement("ul",{className:"tag-list"},n)},n}(t.Component);y.propTypes={tags:t.PropTypes.array.isRequired,onRemoveTag:t.PropTypes.func.isRequired};var S=function(e){function n(t){r.classCallCheck(this,n);var i=r.possibleConstructorReturn(this,e.call(this,t));return i.state={service:null,tags:[]},i.foxbox=t.foxbox,i.onServiceStateChanged=i.onServiceStateChanged.bind(i),i}return r.inherits(n,e),n.prototype.componentDidMount=function(){var e=this;this.foxbox.services.get(this.props.id).then(function(t){e.setState({service:t,tags:t.getTags()})})["catch"](function(e){console.error("Error occurred while retrieving service: ",e)}),this.foxbox.services.on("service-changed",this.onServiceStateChanged)},n.prototype.componentWillUnmount=function(){this.foxbox.services.off("service-changed",this.onServiceStateChanged)},n.prototype.onServiceStateChanged=function(e){e.id===this.props.id&&this.setState({service:e,tags:e.getTags()})},n.prototype.onAddTag=function(){var e=this,t=this.state.service;if(t){var n=(prompt("Enter new tag name")||"").trim();n&&(t.addTag(n)["catch"](function(r){console.error(`Could not add the tag "${n}": %o`,r),e.setState({tags:t.getTags()})}),this.setState({tags:t.getTags()}))}},n.prototype.onRemoveTag=function(e){var t=this,n=this.state.service;n.removeTag(e)["catch"](function(r){console.error(`Could not remove the tag "${e}": %o`,r),t.setState({tags:n.getTags()})}),this.setState({tags:n.getTags()})},n.prototype.renderHeader=function(){var t=this.state.service;return e.prototype.renderHeader.call(this,t&&t.name?t.name:"Unknown Service")},n.prototype.renderBody=function(){return t.createElement("div",{className:"app-view__fill-body"},t.createElement("h2",null,"Tags"),t.createElement(y,{tags:this.state.tags,onRemoveTag:this.onRemoveTag.bind(this)}),t.createElement("button",{className:"add-tag-button",type:"button",onClick:this.onAddTag.bind(this)},"Create a new tag"))},n}(o);S.propTypes={foxbox:t.PropTypes.object.isRequired,id:t.PropTypes.string.isRequired};var k=function(e){function i(){return r.classCallCheck(this,i),r.possibleConstructorReturn(this,e.apply(this,arguments))}return r.inherits(i,e),i.prototype.main=function(e){n.render(t.createElement(S,{id:e,foxbox:this.foxbox}),this.mountNode)},i}(e.Controller),x=function(e){function n(t){r.classCallCheck(this,n);var i=r.possibleConstructorReturn(this,e.call(this,t));return i.state={enabled:t.theme.enabled},i.foxbox=t.foxbox,i.handleOnChange=i.handleOnChange.bind(i),i.handleOnDelete=i.handleOnDelete.bind(i),i}return r.inherits(n,e),n.prototype.handleOnChange=function(e){var t=this,n=e.target.checked;this.setState({enabled:n}),this.foxbox.recipes.toggle(this.props.theme,n)["catch"](function(e){t.setState({enabled:!n}),console.error(e)})},n.prototype.handleOnDelete=function(){var e=this;this.foxbox.recipes.remove(this.props.theme).then(function(){e.props.update()})["catch"](console.error.bind(console))},n.prototype.render=function(){var e="themes-list__item";return this.state.enabled||(e+=" themes-list__item--deactivated"),t.createElement("li",{className:e},t.createElement("input",{className:"themes-list__toggle",type:"checkbox",checked:this.state.enabled,onChange:this.handleOnChange}),t.createElement("span",{className:"themes-list__name"},this.props.theme.label),t.createElement("button",{className:"themes-list__remove",onClick:this.handleOnDelete}))},n}(t.Component);x.propTypes={theme:t.PropTypes.object.isRequired,update:t.PropTypes.func.isRequired,foxbox:t.PropTypes.object.isRequired};var w=function(e){function n(t){r.classCallCheck(this,n);var i=r.possibleConstructorReturn(this,e.call(this,t));return i.state={themes:[]},i.foxbox=t.foxbox,i.update=i.update.bind(i),i}return r.inherits(n,e),n.prototype.componentDidMount=function(){this.update()},n.prototype.update=function(){var e=this;this.foxbox.recipes.getAll().then(function(t){e.setState({themes:t})})["catch"](console.error.bind(console))},n.prototype.renderHeader=function(){return t.createElement("header",{className:"app-view__header"},t.createElement("h1",null,"Recipes"),t.createElement("a",{href:"#themes/new",className:"themes__new-link"},t.createElement("img",{className:"app-view__action-icon",src:"css/icons/plus.svg",alt:"Add a recipe"})))},n.prototype.renderBody=function(){var e=this,n=this.state.themes.map(function(n){return t.createElement(x,{key:n.id,theme:n,update:e.update,foxbox:e.foxbox})});return t.createElement("div",{className:"app-view__fill-body themes"},t.createElement("ul",{className:"themes-list"},n))},n}(o);w.propTypes={foxbox:t.PropTypes.object.isRequired};var C=function(e){function n(t){r.classCallCheck(this,n);var i=r.possibleConstructorReturn(this,e.call(this,t));return i.state={getters:[],setters:[],selectedGetterIndex:-1,selectedGetterValueIndex:-1,selectedSetterIndex:-1,selectedSetterValueIndex:-1},i.foxbox=t.foxbox,i.updateServices=i.updateServices.bind(i),i.onGetterSelected=i.onGetterSelected.bind(i),i.onGetterValueSelected=i.onGetterValueSelected.bind(i),i.onSetterSelected=i.onSetterSelected.bind(i),i.onSetterValueSelected=i.onSetterValueSelected.bind(i),i.onSaveRecipe=i.onSaveRecipe.bind(i),i}return r.inherits(n,e),n.prototype.componentDidMount=function(){var e=this;Promise.all([this.foxbox.recipes.getGetters(),this.foxbox.recipes.getSetters()]).then(function(t){return e.updateServices(t)})["catch"](console.error.bind(console))},n.prototype.updateServices=function(){var e=arguments.length<=0||void 0===arguments[0]?[[],[]]:arguments[0],t=r.slicedToArray(e,2),n=t[0],i=t[1];this.setState({getters:n,setters:i})},n.prototype.onGetterSelected=function(e){var t=-1;e.target.value&&(t=Number(e.target.value)),this.setState({selectedGetterIndex:t,selectedGetterValueIndex:-1,selectedSetterIndex:-1,selectedSetterValueIndex:-1})},n.prototype.onGetterValueSelected=function(e){var t=-1;e.target.value&&(t=Number(e.target.value)),this.setState({selectedGetterValueIndex:t,selectedSetterIndex:-1,selectedSetterValueIndex:-1})},n.prototype.onSetterSelected=function(e){var t=-1;e.target.value&&(t=Number(e.target.value)),this.setState({selectedSetterIndex:t,selectedSetterValueIndex:-1})},n.prototype.onSetterValueSelected=function(e){var t=-1;e.target.value&&(t=Number(e.target.value)),this.setState({selectedSetterValueIndex:t})},n.prototype.onSaveRecipe=function(){if(!(this.state.selectedSetterValueIndex<0)){var e=this.state.getters[this.state.selectedGetterIndex],t=e.options[this.state.selectedGetterValueIndex],n=this.state.setters[this.state.selectedSetterIndex],r=n.options[this.state.selectedSetterValueIndex],i=`${e.name} ${t.label}, `+`${n.name} ${r.label}.`;this.foxbox.recipes.add({name:i,getter:e,getterValue:t,setter:n,setterValue:r}).then(function(){location.hash="#themes"})["catch"](function(e){console.log("Error occurred while saving recipe: ",e)})}},n.prototype.renderHeader=function(){var e="app-view__action";return null===this.state.setter&&(e+=" app-view__action--disabled"),t.createElement("header",{className:"app-view__header"},t.createElement("a",{href:"#themes",className:"app-view__action"},"Cancel"),t.createElement("h1",null,"New Recipe"),t.createElement("button",{className:e,onClick:this.onSaveRecipe},"Done"))},n.prototype.renderBody=function(){var e="new-theme__header";return this.state.selectedGetterValueIndex<0&&(e+=" new-theme__header--hidden"),t.createElement("div",{className:"app-view__fill-body new-theme"},t.createElement("h2",{className:"new-theme__header"},"If"),this.renderGetterSelector(),this.renderGetterValueSelector(),t.createElement("h2",{className:e},"Do"),this.renderSetterSelector(),this.renderSetterValueSelector())},n.prototype.renderGetterSelector=function(){var e=this,n="new-theme__select";this.state.selectedGetterIndex>=0&&(n+=" new-theme__select--selected");var r=this.state.getters.map(function(n,r){return t.createElement("option",{key:r,value:r},e.getChannelName(n))});return t.createElement("select",{value:this.state.selectedGetterIndex,onChange:this.onGetterSelected,className:n},t.createElement("option",{value:""},"Select a device"),r)},n.prototype.renderGetterValueSelector=function(){if(this.state.selectedGetterIndex<0)return t.createElement("select",{className:"new-theme__select new-theme__select--hidden"});var e="new-theme__select";this.state.selectedGetterValueIndex>=0&&(e+=" new-theme__select--selected");var n=this.state.getters[this.state.selectedGetterIndex].options,r=n.map(function(e,n){return t.createElement("option",{key:n,value:n},e.label)});return t.createElement("select",{value:this.state.selectedGetterValueIndex,onChange:this.onGetterValueSelected,className:e},t.createElement("option",{value:""},"Select a property"),r)},n.prototype.renderSetterSelector=function(){var e=this;if(this.state.selectedGetterValueIndex<0)return t.createElement("select",{className:"new-theme__select new-theme__select--hidden"});var n="new-theme__select";this.state.selectedSetterIndex>=0&&(n+=" new-theme__select--selected");var r=this.state.setters.map(function(n,r){return t.createElement("option",{key:r,value:r},e.getChannelName(n))});return t.createElement("select",{value:this.state.selectedSetterIndex,onChange:this.onSetterSelected,className:n},t.createElement("option",{value:""},"Select a device"),r)},n.prototype.renderSetterValueSelector=function(){if(this.state.selectedSetterIndex<0)return t.createElement("select",{className:"new-theme__select new-theme__select--hidden"});var e="new-theme__select";null!==this.state.setter&&(e+=" new-theme__select--selected");var n=this.state.setters[this.state.selectedSetterIndex].options,r=n.map(function(e,n){return t.createElement("option",{key:n,value:n},e.label)});return t.createElement("select",{value:this.state.selectedSetterValueIndex,onChange:this.onSetterValueSelected,className:e},t.createElement("option",{value:""},"Select a property"),r)},n.prototype.getChannelName=function(e){var t=e.tags.join(", ");return t?`${e.name} (${t})`:e.name},n}(o);C.propTypes={foxbox:t.PropTypes.object.isRequired};var E=function(e){function i(){return r.classCallCheck(this,i),r.possibleConstructorReturn(this,e.apply(this,arguments))}return r.inherits(i,e),i.prototype.main=function(){var e=arguments.length<=0||void 0===arguments[0]?"list":arguments[0],r={foxbox:this.foxbox};switch(e){case"list":n.render(t.createElement(w,r),this.mountNode);break;case"new":n.render(t.createElement(C,r),this.mountNode)}},i}(e.Controller),_=function(e){function n(t){r.classCallCheck(this,n);var i=r.possibleConstructorReturn(this,e.call(this,t));return i.state={service:null,hasPreview:!1},i.foxbox=t.foxbox,i}return r.inherits(n,e),n.prototype.componentDidMount=function(){var e=this;this.foxbox.services.get(this.props.id).then(function(t){return e.setState({service:t}),t.getLatestImage()}).then(function(t){e.refs.snapshotPreview.src=URL.createObjectURL(t),e.setState({hasPreview:!0})})["catch"](function(t){console.error("Error occurred while retrieving latest image for camera (id=%s): ",e.props.id,t)})},n.prototype.renderHeader=function(){return e.prototype.renderHeader.call(this,this.state.service&&this.state.service.name?this.state.service.name:"Unknown Service")},n.prototype.renderBody=function(){var e="app-view__fill-body camera-controls";return this.state.hasPreview&&(e+=" camera-controls--has-preview"),t.createElement("div",{className:e},t.createElement("img",{ref:"snapshotPreview",style:{flexGrow:0},alt:"Snapshot preview",className:"camera-controls__preview"}),t.createElement("div",{className:"camera-controls__empty-preview"},t.createElement("p",null,"Preview is being loaded."),t.createElement("p",null,"Wait a moment please!")))},n}(o);_.propTypes={foxbox:t.PropTypes.object.isRequired,id:t.PropTypes.string.isRequired};var O=function(e){function i(){return r.classCallCheck(this,i),r.possibleConstructorReturn(this,e.apply(this,arguments))}return r.inherits(i,e),i.prototype.main=function(e,r){switch(e){case"camera-latest-image":n.render(t.createElement(_,{id:r,foxbox:this.foxbox}),this.mountNode);break;default:console.error('Unknown development view path "%s"',e)}},i}(e.Controller),L=function(e){if(!e||"string"!=typeof e)throw new Error("Event name should be a valid non-empty string!")},T=function(e){if("function"!=typeof e)throw new Error("Handler should be a function!")},N=function(e,t){if(e&&e.indexOf(t)<0)throw new Error(`Event "${t}" is not allowed!`)},I=Object.freeze({allowedEvents:Symbol("allowedEvents"),listeners:Symbol("listeners")}),P=function(){function e(t){if(r.classCallCheck(this,e),"undefined"!=typeof t&&!Array.isArray(t))throw new Error("Allowed events should be a valid array of strings!");this[I.listeners]=new Map,this[I.allowedEvents]=t}return e.prototype.on=function(e,t){L(e),N(this[I.allowedEvents],e),T(t);var n=this[I.listeners].get(e);n||(n=new Set,this[I.listeners].set(e,n)),n.add(t)},e.prototype.once=function t(e,n){var r=this;T(n);var t=function(i){r.off(e,t),n.call(r,i)};this.on(e,t)},e.prototype.off=function(e,t){L(e),N(this[I.allowedEvents],e),T(t);var n=this[I.listeners].get(e);n&&(n["delete"](t),n.size||this[I.listeners]["delete"](e))},e.prototype.offAll=function(e){if("undefined"==typeof e)return void this[I.listeners].clear();L(e),N(this[I.allowedEvents],e);var t=this[I.listeners].get(e);
t&&(t.clear(),this[I.listeners]["delete"](e))},e.prototype.emit=function(e,t){var n=this;L(e),N(this[I.allowedEvents],e);var r=this[I.listeners].get(e);r&&r.forEach(function(e){try{e.call(n,t)}catch(r){console.error(r)}})},e.prototype.hasListeners=function(e){return L(e),N(this[I.allowedEvents],e),this[I.listeners].has(e)},e}(),R="foxbox-",j=1,G="auth",D=/([A-Z])/g,V=Object.freeze({values:Symbol("values"),storage:Symbol("storage"),updateSetting:Symbol("updateSetting"),stringToSettingTypedValue:Symbol("stringToSettingTypedValue"),getDefaultSettingValue:Symbol("getDefaultSettingValue"),onStorage:Symbol("onStorage")}),A=Object.freeze({CONFIGURED:Object.freeze({key:"configured",type:"boolean"}),SKIP_DISCOVERY:Object.freeze({key:"skipDiscovery",type:"boolean"}),SERVICE_POLLING_ENABLED:Object.freeze({key:"servicePollingEnabled",type:"boolean",defaultValue:!0}),SERVICE_POLLING_INTERVAL:Object.freeze({key:"servicePollingInterval",type:"number",defaultValue:2e3}),WATCH_INTERVAL:Object.freeze({key:"watchInterval",type:"number",defaultValue:3e3}),ONLINE_CHECKING_INTERVAL:Object.freeze({key:"onlineCheckingInterval",type:"number",defaultValue:5e3}),ONLINE_CHECKING_LONG_INTERVAL:Object.freeze({key:"onlineCheckingLongInterval",type:"number",defaultValue:3e5}),LOCAL_ORIGIN:Object.freeze({key:"localOrigin"}),TUNNEL_ORIGIN:Object.freeze({key:"tunnelOrigin"}),CLIENT:Object.freeze({key:"client"}),SESSION:Object.freeze({key:"session"}),PUSH_ENDPOINT:Object.freeze({key:"pushEndpoint"}),PUSH_PUB_KEY:Object.freeze({key:"pushPubKey"}),PUSH_AUTH:Object.freeze({key:"pushAuth"}),REGISTRATION_SERVICE:Object.freeze({key:"registrationService",defaultValue:"https://knilxof.org:4443/ping"})}),U=function(e){function t(){var n=arguments.length<=0||void 0===arguments[0]?localStorage:arguments[0];r.classCallCheck(this,t);var i=r.possibleConstructorReturn(this,e.call(this));return i[V.storage]=n||{getItem:function(){return null},setItem:function(){},removeItem:function(){},clear:function(){}},i[V.values]=new Map,Object.keys(A).forEach(function(e){var t=A[e],n=i[V.storage].getItem(`${R}${t.key}`);i[V.values].set(t,i[V.stringToSettingTypedValue](t,n))}),window.addEventListener("storage",i[V.onStorage].bind(i)),Object.seal(i),i}return r.inherits(t,e),t.prototype.clear=function(){var e=this;return new Promise(function(t){Object.keys(A).forEach(function(t){var n=A[t];e[V.updateSetting](n,e[V.getDefaultSettingValue](n))}),t()})},t.prototype[V.updateSetting]=function(e,t){var n=this[V.values].get(e);n!==t&&(this[V.values].set(e,t),t!==this[V.getDefaultSettingValue](e)?this[V.storage].setItem(`${R}${e.key}`,t):this[V.storage].removeItem(`${R}${e.key}`),this.emit(e.key.replace(D,function(e){return`-${e.toLowerCase()}`}),t))},t.prototype[V.stringToSettingTypedValue]=function(e,t){return null===t?this[V.getDefaultSettingValue](e):"boolean"===e.type?"true"===t:"number"===e.type?Number(t):t},t.prototype[V.getDefaultSettingValue]=function(e){return void 0!==e.defaultValue?e.defaultValue:"boolean"!==e.type&&("number"===e.type?0:null)},t.prototype[V.onStorage]=function(e){if(e.key.startsWith(R)){var t=e.key.substring(R.length),n=Object.keys(A).find(function(e){return A[e].key===t});if(!n)return void console.warn(`Changed unknown storage entry with app specific prefix: ${e.key}`);var r=A[n];this[V.updateSetting](r,this[V.stringToSettingTypedValue](r,e.newValue))}},r.createClass(t,[{key:"configured",get:function(){return this[V.values].get(A.CONFIGURED)},set:function(e){this[V.updateSetting](A.CONFIGURED,e)}},{key:"localOrigin",get:function(){return this[V.values].get(A.LOCAL_ORIGIN)},set:function(e){this[V.updateSetting](A.LOCAL_ORIGIN,e?new URL(e).origin:null)}},{key:"tunnelOrigin",get:function(){return this[V.values].get(A.TUNNEL_ORIGIN)},set:function(e){this[V.updateSetting](A.TUNNEL_ORIGIN,e?new URL(e).origin:null)}},{key:"client",get:function(){return this[V.values].get(A.CLIENT)},set:function(e){this[V.updateSetting](A.CLIENT,e?String(e):null)}},{key:"session",get:function(){return this[V.values].get(A.SESSION)},set:function(e){this[V.updateSetting](A.SESSION,e)}},{key:"skipDiscovery",get:function(){return this[V.values].get(A.SKIP_DISCOVERY)},set:function(e){this[V.updateSetting](A.SKIP_DISCOVERY,e)}},{key:"servicePollingEnabled",get:function(){return this[V.values].get(A.SERVICE_POLLING_ENABLED)},set:function(e){this[V.updateSetting](A.SERVICE_POLLING_ENABLED,e)}},{key:"pushEndpoint",get:function(){return this[V.values].get(A.PUSH_ENDPOINT)},set:function(e){this[V.updateSetting](A.PUSH_ENDPOINT,e)}},{key:"pushPubKey",get:function(){return this[V.values].get(A.PUSH_PUB_KEY)},set:function(e){this[V.updateSetting](A.PUSH_PUB_KEY,e)}},{key:"pushAuth",get:function(){return this[V.values].get(A.PUSH_AUTH)},set:function(e){this[V.updateSetting](A.PUSH_AUTH,e)}},{key:"registrationService",get:function(){return this[V.values].get(A.REGISTRATION_SERVICE)}},{key:"servicePollingInterval",get:function(){return this[V.values].get(A.SERVICE_POLLING_INTERVAL)}},{key:"onlineCheckingInterval",get:function(){return this[V.values].get(A.ONLINE_CHECKING_INTERVAL)}},{key:"onlineCheckingLongInterval",get:function(){return this[V.values].get(A.ONLINE_CHECKING_LONG_INTERVAL)}},{key:"watchInterval",get:function(){return this[V.values].get(A.WATCH_INTERVAL)}},{key:"queryStringAuthTokenName",get:function(){return G}},{key:"apiVersion",get:function(){return j}}]),t}(P),B=Object.freeze({promise:Symbol("promise"),resolve:Symbol("resolve"),reject:Symbol("reject")}),H=function(){function e(){var t=this;r.classCallCheck(this,e),this[B.promise]=new Promise(function(e,n){t[B.resolve]=e,t[B.reject]=n}),Object.freeze(this)}return e.prototype.resolve=function(e){this[B.resolve](e)},e.prototype.reject=function(e){this[B.reject](e)},r.createClass(e,[{key:"promise",get:function(){return this[B.promise]}}]),e}(),z=Object.freeze({db:Symbol("db"),initializationStarted:Symbol("initializationStarted"),upgradeSchema:Symbol("upgradeSchema"),getAll:Symbol("getAll"),getById:Symbol("getById"),set:Symbol("set"),remove:Symbol("remove"),clearDb:Symbol("clearDb")}),M="foxbox-db",q=1,W="services",F=function(){function e(){r.classCallCheck(this,e),this[z.db]=new H,this[z.initializationStarted]=!1,Object.seal(this)}return e.prototype.init=function(){var e=this,t=this[z.db].promise.then(function(){});if(this[z.initializationStarted])return t;try{var n=indexedDB.open(M,q);n.onupgradeneeded=this[z.upgradeSchema],n.onsuccess=function(t){return e[z.db].resolve(t.target.result)},n.onerror=function(t){return e[z.db].reject(t)}}catch(r){this[z.db].reject(r)}return t["catch"](function(e){throw console.error("Error opening database: %o",e),e})},e.prototype.clear=function(){var e=this;return this[z.db].promise.then(function(e){return e.close(),new Promise(function(e,t){var n=indexedDB.deleteDatabase(M);n.onsuccess=e,n.onerror=t,n.onblocked=t})}).then(function(){e[z.db]=new H,e[z.initializationStarted]=!1})},e.prototype.getServices=function(){return this[z.getAll](W)},e.prototype.getService=function(e){return this[z.getById](W,e)},e.prototype.setService=function(e){return this[z.set](W,e)},e.prototype.deleteService=function(e){return this[z.remove](W,e.id)},e.prototype.clearServices=function(){return this[z.clearDb](W)},e.prototype[z.upgradeSchema]=function(e){var t=e.target.result,n=e.oldVersion;if(1>n){var r=t.createObjectStore(W,{keyPath:"id"});r.createIndex("id","id",{unique:!0})}},e.prototype[z.getAll]=function(e){return this[z.db].promise.then(function(t){return new Promise(function(n,r){var i=t.transaction([e],"readonly"),o=[];i.onerror=r,i.oncomplete=function(){return n(o)},i.objectStore(e).openCursor().onsuccess=function(e){var t=e.target.result;t&&(o.push(t.value),t["continue"]())}})})},e.prototype[z.getById]=function(e,t){return this[z.db].promise.then(function(n){return new Promise(function(r,i){var o=n.transaction([e],"readonly");o.onerror=i,o.objectStore(e).get(t).onsuccess=function(e){r(e.target.result)}})})},e.prototype[z.set]=function(e,t){return this[z.db].promise.then(function(n){return new Promise(function(r,i){var o=n.transaction([e],"readwrite");o.oncomplete=r,o.onerror=i;try{o.objectStore(e).put(t)}catch(s){console.error(`Error putting data in ${M}:`,s),r()}})})},e.prototype[z.remove]=function(e,t){return this[z.db].promise.then(function(n){return new Promise(function(r,i){var o=n.transaction([e],"readwrite");o.oncomplete=r,o.onerror=i;try{o.objectStore(e)["delete"](t)}catch(s){console.error(`Error deleting data from ${M}:`,s),r()}})})},e.prototype[z.clearDb]=function(e){return this[z.db].promise.then(function(t){return new Promise(function(n,r){var i=t.transaction([e],"readwrite");i.oncomplete=n,i.onerror=r,i.objectStore(e).clear()})})},e}(),J=Object.freeze({started:Symbol("started"),nextTickHandle:Symbol("nextTickHandle"),scheduleTick:Symbol("scheduleTick"),onTick:Symbol("onTick")}),K=function(){function e(t){r.classCallCheck(this,e),this.interval=t,this[J.started]=!1,this[J.nextTickHandle]=null,this[J.onTick]=null,Object.seal(this)}return e.prototype.start=function(e){if(this[J.started])return void console.warn("Timer has been already started.");if("function"!=typeof e)throw new Error("onTick handler should be a valid function.");this[J.started]=!0,this[J.onTick]=e,this[J.scheduleTick]()},e.prototype.stop=function(){return this[J.started]?(this[J.started]=!1,clearTimeout(this[J.nextTickHandle]),this[J.nextTickHandle]=null,void(this[J.onTick]=null)):void console.warn("Timer has not been started yet.")},e.prototype[J.scheduleTick]=function(){var e=this;this[J.started]&&!this[J.nextTickHandle]&&(this[J.nextTickHandle]=setTimeout(function(){new Promise(function(t){return t(e[J.onTick]())})["catch"](function(e){console.error("onTick handler failed, scheduling next tick anyway: %o",e)}).then(function(){e[J.nextTickHandle]=null,e[J.scheduleTick]()})},this.interval))},r.createClass(e,[{key:"started",get:function(){return this[J.started]}}]),e}(),Y=Object.freeze({origin:Symbol("origin"),online:Symbol("online"),lastSeenOnline:Symbol("lastSeenOnline"),pingTimer:Symbol("pingTimer"),ping:Symbol("ping")}),Z=function(e){function t(n){r.classCallCheck(this,t);var i=r.possibleConstructorReturn(this,e.call(this,["online"]));if(!n)throw new Error("Origin should be valid non-empty string.");return i[Y.ping]=i[Y.ping].bind(i),i[Y.origin]=n,i[Y.online]=!1,i[Y.lastSeenOnline]=0,i[Y.pingTimer]=new K(Number.POSITIVE_INFINITY),Object.seal(i),i}return r.inherits(t,e),t.prototype.seenOnline=function(){this[Y.online]=!0,this[Y.lastSeenOnline]=Date.now()},t.prototype.enableAutoPing=function(e){if("number"!=typeof e||0>e)throw new Error("Interval should valid positive number.");this[Y.pingTimer].interval=e,this[Y.pingTimer].started||this[Y.pingTimer].start(this[Y.ping])},t.prototype.disableAutoPing=function(){this[Y.pingTimer].started&&this[Y.pingTimer].stop()},t.prototype.ping=function(){return this[Y.ping](!0)},t.prototype[Y.ping]=function(e){var t=this,n=Date.now()-this[Y.lastSeenOnline]<this[Y.pingTimer].interval;return e||!n&&!document.hidden?fetch(`${this[Y.origin]}/ping`,{cache:"no-store"}).then(function(e){return e.ok},function(e){return console.error("Error occurred while pinging box: %o",e),!1}).then(function(e){if(e&&(t[Y.lastSeenOnline]=Date.now()),t[Y.online]!==e)return t[Y.online]=e,t.emit("online",e),e}):Promise.resolve()},r.createClass(t,[{key:"origin",get:function(){return this[Y.origin]}},{key:"online",get:function(){return this[Y.online]}}]),t}(P),$=Object.freeze({settings:Symbol("settings"),localLink:Symbol("localLink"),tunnelLink:Symbol("tunnelLink"),linkPingInterval:Symbol("linkPingInterval"),online:Symbol("online"),fetch:Symbol("fetch"),pingLinks:Symbol("pingLinks"),updateLink:Symbol("updateLink"),onLinkOnlineChange:Symbol("onLinkOnlineChange"),onLinkOriginChange:Symbol("onLinkOriginChange")}),Q=function(e){function t(n){r.classCallCheck(this,t);var i=r.possibleConstructorReturn(this,e.call(this,["online"]));return i[$.settings]=n,i[$.localLink]=null,i[$.tunnelLink]=null,i[$.linkPingInterval]=null,i[$.online]=!1,i[$.pingLinks]=i[$.pingLinks].bind(i),i[$.onLinkOnlineChange]=i[$.onLinkOnlineChange].bind(i),i[$.onLinkOriginChange]=i[$.onLinkOriginChange].bind(i),Object.seal(i),i}return r.inherits(t,e),t.prototype.init=function(){return window.addEventListener("online",this[$.pingLinks]),window.addEventListener("offline",this[$.pingLinks]),"connection"in navigator&&"onchange"in navigator.connection?(navigator.connection.addEventListener("change",this[$.pingLinks]),this[$.linkPingInterval]=this[$.settings].onlineCheckingLongInterval):this[$.linkPingInterval]=this[$.settings].onlineCheckingInterval,this[$.settings].on("local-origin",this[$.onLinkOriginChange]),this[$.settings].on("tunnel-origin",this[$.onLinkOriginChange]),this[$.onLinkOriginChange](),Promise.resolve()},t.prototype.fetchJSON=function(e){var t=arguments.length<=1||void 0===arguments[1]?"GET":arguments[1],n=arguments.length<=2||void 0===arguments[2]?void 0:arguments[2];return this[$.fetch](e,"application/json",t,n).then(function(e){return e.json()})},t.prototype.fetchBlob=function(e,t,n,r){return this[$.fetch](e,t,n,r).then(function(e){return e.blob()})},t.prototype[$.fetch]=function(e,t){var n=this,r=arguments.length<=2||void 0===arguments[2]?"GET":arguments[2],i=arguments.length<=3||void 0===arguments[3]?void 0:arguments[3];r=r.toUpperCase();var o={method:r,headers:{Accept:t},cache:"no-store"};return"POST"!==r&&"PUT"!==r&&"DELETE"!==r||(o.headers["Content-Type"]="application/json;charset=UTF-8"),this[$.settings].session&&(o.headers.Authorization=`Bearer ${this[$.settings].session}`),void 0!==i&&(o.body=JSON.stringify(i)),fetch(e,o).then(function(t){if(!t.ok)throw new TypeError(`The response returned a ${t.status} HTTP status code.`);var r=new URL(e).origin;return n[$.localLink]&&n[$.localLink].origin===r?n[$.localLink].seenOnline():n[$.tunnelLink]&&n[$.tunnelLink].origin===r&&n[$.tunnelLink].seenOnline(),t})["catch"](function(e){throw console.error("Error occurred while fetching content: ",e),e})},t.prototype[$.pingLinks]=function(){this[$.localLink]&&this[$.localLink].ping(),this[$.tunnelLink]&&this[$.tunnelLink].ping()},t.prototype[$.updateLink]=function(e,t){var n=this[e];!t&&!n||n&&n.origin===t||(n&&(n.off("online",this[$.onLinkOnlineChange]),n.disableAutoPing(),this[e]=null),t&&(this[e]=new Z(t),this[e].enableAutoPing(this[$.linkPingInterval]),this[e].on("online",this[$.onLinkOnlineChange]),this[e].ping()),this[$.onLinkOnlineChange]())},t.prototype[$.onLinkOriginChange]=function(){this[$.updateLink]($.localLink,this.localOrigin),this[$.updateLink]($.tunnelLink,this.tunnelOrigin)},t.prototype[$.onLinkOnlineChange]=function(){var e=!!this[$.localLink]&&this[$.localLink].online||!!this[$.tunnelLink]&&this[$.tunnelLink].online;this[$.online]!==e&&(this[$.online]=e,this.emit("online",e))},r.createClass(t,[{key:"origin",get:function(){if(this[$.localLink])return this[$.localLink].origin;if(this[$.tunnelLink])return this[$.tunnelLink].origin;throw new Error("Origin is not accessible")}},{key:"localOrigin",get:function(){return this[$.settings].localOrigin}},{key:"tunnelOrigin",get:function(){return this[$.settings].tunnelOrigin}},{key:"online",get:function(){return this[$.online]}}]),t}(P),X=Object.freeze({api:Symbol("api"),service:Symbol("service")}),ee=function(){function e(t){if(r.classCallCheck(this,e),!t)throw new Error("Service is required!");this[X.service]=t}return r.createClass(e,[{key:"id",get:function(){return this[X.service].id}},{key:"label",get:function(){return this[X.service].source&&this[X.service].source.name}},{key:"enabled",get:function(){return this[X.service].status}}]),e}(),te=function(){function e(t){r.classCallCheck(this,e),this[X.api]=t,Object.seal(this)}return e.prototype.getAll=function(){var e=this;return this[X.api].post("services",{channels:[{feature:"thinkerbell/rule-source"}]}).then(function(e){return e.map(function(e){return Object.keys(e.channels).reduce(function(t,n){var r=e.channels[n];switch(r.feature){case"thinkerbell/is-rule-enabled":t.enabled=n;break;case"thinkerbell/rule-source":t.getSource=n;break;case"thinkerbell/remove-rule-id":t.remove=n}return t},{id:e.id,getSource:null,enabled:null,remove:null,status:null,source:null})})}).then(function(t){var n=t.reduce(function(e,t){return e.enabledSelectors.push({id:t.enabled}),e.sourceSelectors.push({id:t.getSource}),e},{enabledSelectors:[],sourceSelectors:[]}),i=n.enabledSelectors,o=n.sourceSelectors;return Promise.all([e[X.api].put("channels/get",i),e[X.api].put("channels/get",o)]).then(function(e){var n=r.slicedToArray(e,2),i=n[0],o=n[1];return t.map(function(e){var t=i[e.enabled],n=o[e.getSource];return t&&t.OnOff?e.status="On"===t.OnOff:(console.error("Error occurred while retrieving recipe (%s) status: ",e.id,t&&t.Error),e.status=!1),n&&n.String?e.source=JSON.parse(n.String):(console.error("Error occurred while retrieving recipe (%s) source: ",e.id,n&&n.Error),e.source=null),new ee(e)})})})},e.prototype.getGetters=function(){var e=["clock/time-of-day-seconds","door/is-open","door/is-locked"];return this[X.api].post("channels",e.map(function(e){return{feature:e,supports_fetch:!0}})).then(function(e){return e.map(function(e){var t=void 0,n=[];switch(e.feature){case"clock/time-of-day-seconds":t="Everyday",n.push.apply(n,[{label:"in the morning",value:{Geq:{Duration:28800}}},{label:"in the afternoon",value:{Geq:{Duration:50400}}},{label:"in the evening",value:{Geq:{Duration:64800}}}]);break;case"door/is-open":t="Motion Sensor",n.push({label:"detects motion",value:{Eq:{OpenClosed:"Open"}}});break;case"door/is-locked":t="Door",n.push({label:"is locked",value:{Eq:{DoorLocked:"Locked"}}},{label:"is unlocked",value:{Eq:{DoorLocked:"Unlocked"}}})}return{id:e.id,feature:e.feature,name:t||e.adapter,tags:e.tags,options:n}})})},e.prototype.getSetters=function(){var e=["speak/sentence","camera/store-snapshot","light/is-on","door/is-locked"];return this[X.api].post("channels",e.map(function(e){return{feature:e,supports_send:!0}})).then(function(e){return e.map(function(e){var t=[],n=void 0;switch(e.feature){case"speak/sentence":n="say",t.push.apply(t,[{label:'"Good morning!"',value:{String:'"Good morning!"'}},{label:'"Good afternoon!"',value:{String:'"Good afternoon!"'}},{label:'"Good evening!"',value:{String:'"Good evening!"'}}]);break;case"camera/store-snapshot":n="camera",t.push.apply(t,[{label:"takes a picture",value:{Unit:null}},{label:"sends me a picture",value:[{destination:[{id:e.id}],feature:"camera/store-snapshot",value:{Unit:null}},{destination:[{feature:"webpush/notify-msg"}],feature:"webpush/notify-msg",value:{WebPushNotify:{message:JSON.stringify({message:"Your bedroom patio door has just been opened. Here is a picture of what I see.",action:`dev/camera-latest-image/${e.service}`}),resource:"res1"}}}]}]);break;case"light/is-on":n="light",t.push.apply(t,[{label:"gets turned on",value:{OnOff:"On"}},{label:"gets turned off",value:{OnOff:"Off"}}]);break;case"door/is-locked":n="door lock",t.push.apply(t,[{label:"locks the door",value:{DoorLocked:"Locked"}},{label:"unlocks the door",value:{DoorLocked:"Unlocked"}}])}return{id:e.id,feature:e.feature,name:n||e.adapter,tags:e.tags,options:t}})})},e.prototype.add=function(e){var t=e.name,n=e.getter,r=e.getterValue,i=e.setter,o=e.setterValue,s=void 0;Array.isArray(o.value)?s=o.value:"object"==typeof o.value?s=[{destination:[{id:i.id}],feature:i.feature,value:o.value}]:console.error("Setter doesn't have a supported format:",JSON.stringify(i));var a={name:t,rules:[{conditions:[{source:[{id:n.id}],feature:n.feature,range:r.value}],execute:s}]};return this[X.api].put("channels/set",{select:{feature:"thinkerbell/add-rule"},value:{ThinkerbellRule:{name:t,source:JSON.stringify(a)}}})},e.prototype.remove=function(e){return this[X.api].put("channels/set",{select:{id:e[X.service].remove},value:null})},e.prototype.toggle=function(e){var t=arguments.length<=1||void 0===arguments[1]||arguments[1],n=t?"On":"Off";return this[X.api].put("channels/set",{select:{id:e[X.service].enabled},value:{OnOff:n}}).then(function(){e[X.service].status=t})},e.prototype.createDemoRecipes=function(){var e=this;Promise.all([this.getGetters(),this.getSetters()]).then(function(t){var n=r.slicedToArray(t,2),i=n[0],o=n[1],s=i.find(function(e){return"clock/time-of-day-seconds"===e.feature}),a=o.filter(function(e){return"light/is-on"===e.feature}),c=[{source:[{id:s.id}],feature:"clock/time-of-day-seconds",range:{Geq:{Duration:28800}}}],l=[].concat(a.map(function(e){return{destination:[{id:e.id}],feature:e.feature,value:{OnOff:"Off"}}}),[{destination:[{feature:"webpush/notify-msg"}],feature:"webpush/notify-msg",value:{WebPushNotify:{message:JSON.stringify({message:"Hello Alex, I've turned your kitchen lights off for you. Have a wonderful day!"}),resource:"res1"}}}]),u={name:"Turn off the lights when I leave for work.",rules:[{conditions:c,execute:l}]};return console.log("Recipe for the demo",u),e[X.api].put("channels/set",{select:{feature:"thinkerbell/add-rule"},value:{ThinkerbellRule:{name,source:JSON.stringify(u)}}})}),this.createDoorLockDemoRecipe()},e.prototype.createDoorLockDemoRecipe=function(){var e=this;Promise.all([this.getGetters(),this.getSetters()]).then(function(t){var n=r.slicedToArray(t,2),i=n[0],o=n[1],s=i.find(function(e){return"clock/time-of-day-seconds"===e.feature}),a=i.find(function(e){return"door/is-locked"===e.feature}),c=o.find(function(e){return"door/is-locked"===e.feature}),l=[{source:[{id:s.id}],feature:"clock/time-of-day-seconds",range:{Geq:{Duration:28800}}},{source:[{id:a.id}],feature:a.feature,range:{Eq:{DoorLocked:"Unlocked"}}}],u=[{destination:[{id:c.id}],feature:c.feature,value:{DoorLocked:"Locked"}},{destination:[{feature:"webpush/notify-msg"}],feature:"webpush/notify-msg",value:{WebPushNotify:{message:JSON.stringify({message:"Hello Alex, I've locked the door for you. Have a wonderful day!"}),resource:"res1"}}}],h={name:"Lock the door when I leave for work.",rules:[{conditions:l,execute:u}]};return e[X.api].put("channels/set",{select:{feature:"thinkerbell/add-rule"},value:{ThinkerbellRule:{name,source:JSON.stringify(h)}}})})},e}(),ne=Object.freeze({api:Symbol("api"),settings:Symbol("settings"),listenForMessages:Symbol("listenForMessages")}),re=function(e){function t(n,i){r.classCallCheck(this,t);var o=r.possibleConstructorReturn(this,e.call(this,["message"]));return o[ne.api]=n,o[ne.settings]=i,Object.seal(o),o}return r.inherits(t,e),t.prototype.subscribeToNotifications=function(){var e=this,t=!(arguments.length<=0||void 0===arguments[0])&&arguments[0];if(!navigator.serviceWorker)return Promise.reject("No service worker supported");navigator.serviceWorker.addEventListener("message",this[ne.listenForMessages].bind(this));var n=this[ne.settings];return n.pushEndpoint&&n.pushPubKey&&n.pushAuth&&!t?Promise.resolve():navigator.serviceWorker.ready.then(function(e){return e.pushManager.subscribe({userVisibleOnly:!0})}).then(function(t){var r=t.endpoint,i=t.getKey?t.getKey("p256dh"):"",o=t.getKey?t.getKey("auth"):"";n.pushEndpoint=r,n.pushPubKey=btoa(String.fromCharCode.apply(null,new Uint8Array(i))),n.pushAuth=btoa(String.fromCharCode.apply(null,new Uint8Array(o)));var s=[[[{id:"setter:subscribe.webpush@link.mozilla.org"}],{Json:{subscriptions:[{public_key:n.pushPubKey,push_uri:n.pushEndpoint,auth:n.pushAuth}]}}]];return e[ne.api].put("channels/set",s)}).then(function(){var t=[[[{id:"setter:resource.webpush@link.mozilla.org"}],{Json:{resources:["res1"]}}]];return e[ne.api].put("channels/set",t)})["catch"](function(e){if("denied"===Notification.permission)throw new Error("Permission request was denied.");throw console.error("Error while saving subscription ",e),new Error(`Subscription error: ${e}`)})},t.prototype[ne.listenForMessages]=function(e){var t=e.data||{};t.action&&this.emit("message",t)},t}(P),ie="unknown",oe=Object.freeze({api:Symbol("api"),id:Symbol("id"),manufacturer:Symbol("manufacturer"),model:Symbol("model"),name:Symbol("name"),watchers:Symbol("watchers"),tags:Symbol("tags"),channels:Symbol("channels"),getChannels:Symbol("getChannel"),getFetchChannel:Symbol("getFetchChannel"),getSendChannel:Symbol("getSendChannel")}),se=function(e){function t(n,i,o,s){r.classCallCheck(this,t);var a=r.possibleConstructorReturn(this,e.call(this,o));return a[oe.api]=i,a[oe.id]=n.id,a[oe.manufacturer]=n.properties&&n.properties.manufacturer||"",a[oe.model]=n.properties&&n.properties.model||"",a[oe.name]=n.properties&&n.properties.name||n.properties.product_name||"",a[oe.tags]=new Set(n.tags),a[oe.channels]=n.channels,a[oe.watchers]=s||new Map,a}return r.inherits(t,e),t.prototype.set=function(e){var t=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=this[oe.getSendChannel](e),r=n.supports_send.accepts,i=[{id:n.id},r?{[r.requires||r.optional]:t}:null];return this[oe.api].put("channels/set",[i])},t.prototype.get=function(e){var t=this[oe.getFetchChannel](e),n=t.supports_fetch.returns,r={id:t.id};return n&&"Binary"===(n.requires||n.optional)?this[oe.api].blob("channels/get",r):this[oe.api].put("channels/get",r).then(function(e){return e[t.id]})},t.prototype.watch=function(e,t){var n=this,i=this[oe.watchers].get(e);if(!i)throw new Error("Unsupported watcher `${alias}`!");var o=r.slicedToArray(i,3),s=o[0],a=o[1],c=o[2],l=void 0===c?new Map:c;0===l.size&&i.push(l);var u=l.get(t);u||(u=function(e){return t(n[a](e))},l.set(t,u));var h=this[oe.getFetchChannel](s),p=h.id;this[oe.api].watch(p,u)},t.prototype.unwatch=function(e,t){var n=this[oe.watchers].get(e);if(!n)throw new Error("Unsupported watcher `${alias}`!");var i=r.slicedToArray(n,3),o=i[0],s=i[2],a=s.get(t);s["delete"](t);var c=this[oe.getFetchChannel](o),l=c.id;this[oe.api].unwatch(l,a)},t.prototype.getTags=function(){return Array.from(this[oe.tags])},t.prototype.addTag=function(e){var t=this;if(!e||"string"!=typeof e)throw new Error("Tag should be valid non-empty string.");if(this[oe.tags].has(e))return Promise.resolve();this[oe.tags].add(e);var n={services:{id:this[oe.id]},tags:e},r={channels:{service:this[oe.id]},tags:e};return Promise.all([this[oe.api].post("services/tags",n),this[oe.api].post("channels/tags",r)])["catch"](function(n){throw t[oe.tags]["delete"](e),n})},t.prototype.removeTag=function(e){var t=this;if(!e||"string"!=typeof e)throw new Error("Tag should be valid non-empty string.");if(!this[oe.tags].has(e))return Promise.resolve();this[oe.tags]["delete"](e);var n={services:{id:this[oe.id]},tags:e},r={channels:{service:this[oe.id]},tags:e};return Promise.all([this[oe.api]["delete"]("services/tags",n),this[oe.api]["delete"]("channels/tags",r)])["catch"](function(n){throw t[oe.tags].add(e),n})},t.prototype.teardown=function(){for(var e of this[oe.watchers].values()){var t=r.slicedToArray(e,3),n=t[0],i=t[2];if(i&&0!==i.size){var o=this[oe.getFetchChannel](n),s=o.id;for(var a of i.values())console.warn(`Forgotten watcher for ${s}!`),this[oe.api].unwatch(s,a);i.clear()}}},t.prototype[oe.getChannels]=function(e){var t=this;if(e.id){var n=this[oe.channels][e.id];return n?[n]:[]}if(e.feature||"string"==typeof e){var r=function(){var n=e.feature||e;return{v:Object.keys(t[oe.channels]).reduce(function(e,r){var i=t[oe.channels][r];return i.feature===n&&e.push(i),e},[])}}();if("object"==typeof r)return r.v}return[]},t.prototype[oe.getFetchChannel]=function(e){var t=this[oe.getChannels](e).find(function(e){return e.supports_fetch});if(!t)throw new Error(`Couldn't find channel that supports "fetch" with selector: ${e}`);return t},t.prototype[oe.getSendChannel]=function(e){var t=this[oe.getChannels](e).find(function(e){return e.supports_send});if(!t)throw new Error(`Couldn't find channel that supports "send" with selector: ${e}`);return t},r.createClass(t,[{key:"type",get:function(){return ie}},{key:"id",get:function(){return this[oe.id]}},{key:"manufacturer",get:function(){return this[oe.manufacturer]}},{key:"model",get:function(){return this[oe.model]}},{key:"name",get:function(){return this[oe.name]}}]),t}(P),ae="ip-camera",ce=function(e){function t(n,i){r.classCallCheck(this,t);var o=r.possibleConstructorReturn(this,e.call(this,n,i));return Object.seal(o),o}return r.inherits(t,e),t.prototype.getLatestImage=function(){return this.get("camera/x-latest-image")},t.prototype.takeSnapshot=function(){var e=this;return this.set("camera/store-snapshot").then(function(){return e.get("camera/x-latest-image")})},r.createClass(t,[{key:"type",get:function(){return ae}}]),t}(se),le="light",ue=function(e){function t(n,i){r.classCallCheck(this,t);var o=r.possibleConstructorReturn(this,e.call(this,n,i));return Object.seal(o),o}return r.inherits(t,e),t.prototype.isAvailable=function(){return this.get("device/available").then(function(e){return"On"===e.OnOff})},t.prototype.isOn=function(){return this.get("light/is-on").then(function(e){return"On"===e.OnOff})},t.prototype.turn=function(e){return this.set("light/is-on",e?"On":"Off")},r.createClass(t,[{key:"type",get:function(){return le}}]),t}(se),he="door-lock",pe=function(e){function t(n,i){r.classCallCheck(this,t);var o=r.possibleConstructorReturn(this,e.call(this,n,i));return Object.seal(o),o}return r.inherits(t,e),t.prototype.isLocked=function(){return this.get("door/is-locked").then(function(e){if(!e)throw new Error("Door lock status is not available yet!");return"Locked"===e.DoorLocked})},t.prototype.lockUnlock=function(e){return this.set("door/is-locked",e?"Locked":"Unlocked")},r.createClass(t,[{key:"type",get:function(){return he}}]),t}(se),de="motion-sensor",fe=Object.freeze({onMotionStateChanged:Symbol("onMotionStateChanged")}),ve=function(e){return!!e&&"Open"===e.OpenClosed},ge=function(e){function t(n,i){r.classCallCheck(this,t);var o=r.possibleConstructorReturn(this,e.call(this,n,i,void 0,new Map([["motion",["door/is-open",fe.onMotionStateChanged]]])));return Object.freeze(o),o}return r.inherits(t,e),t.prototype.isMotionDetected=function(){return this.get("door/is-open").then(ve)},t.prototype[fe.onMotionStateChanged]=function(e){return ve(e)},r.createClass(t,[{key:"type",get:function(){return de}}]),t}(se),me=Object.freeze({api:Symbol("api"),settings:Symbol("settings"),db:Symbol("db"),cache:Symbol("services"),pollingTimer:Symbol("pollingTimer"),getServiceInstance:Symbol("getServiceInstance"),hasChannelWithFeature:Symbol("hasChannelWithFeature"),getCache:Symbol("getCache")}),be=function(e,t){var n=Object.keys(e),r=Object.keys(t);return n.length===r.length&&!n.some(function(n){var r=e[n],i=t[n],o=typeof r;return o!==typeof i||("object"!==o||null===r||null===i?r!==i:Array.isArray(r)?r.length!==i.length||r.some(function(e,t){return e!==i[t]}):!be(r,i))})},ye=function(e){function t(n,i,o){r.classCallCheck(this,t);var s=r.possibleConstructorReturn(this,e.call(this,["services-changed","service-changed"]));return s[me.db]=n,s[me.api]=i,s[me.settings]=o,s[me.cache]=null,s[me.pollingTimer]=new K(s[me.settings].servicePollingInterval),Object.seal(s),s}return r.inherits(t,e),t.prototype.getAll=function(){return this[me.getCache]().then(function(e){return Array.from(e.values())})},t.prototype.get=function(e){return this[me.getCache]().then(function(t){return t.get(e)})},t.prototype.togglePolling=function(e){e!==this[me.pollingTimer].started&&(e?this[me.pollingTimer].start(this.sync.bind(this)):this[me.pollingTimer].stop())},t.prototype.sync=function(){var e=this;return Promise.all([this[me.api].get("services"),this[me.db].getServices(),this[me.getCache]()]).then(function(t){var n=r.slicedToArray(t,3),i=n[0],o=n[1],s=n[2],a=0;i.forEach(function(t){var n=o.find(function(e){return e.id===t.id}),r=!!n;if(!r||!be(t,n)){e[me.db].setService(t);var i=e[me.getServiceInstance](t);s.set(i.id,i),r?e.emit("service-changed",i):a++}});var c=o.length+a-i.length;c>0&&o.forEach(function(t){var n=i.find(function(e){return e.id===t.id});if(!n){e[me.db].deleteService(t);var r=s.get(t.id);r.teardown(),s["delete"](r.id)}}),(a>0||c>0)&&e.emit("services-changed")})},t.prototype[me.getCache]=function(){var e=this;return this[me.cache]?this[me.cache]:this[me.cache]=this[me.db].getServices()["catch"](function(e){
return console.error("Could not load services from the local DB: %o",e),[]}).then(function(t){var n=new Map;return t.forEach(function(t){n.set(t.id,e[me.getServiceInstance](t))}),n})},t.prototype[me.getServiceInstance]=function(e){switch(e.adapter){case"ip-camera@link.mozilla.org":return new ce(e,this[me.api]);case"philips_hue@link.mozilla.org":return new ue(e,this[me.api]);case"OpenZwave Adapter":return this[me.hasChannelWithFeature](e.channels,"door/is-locked")?new pe(e,this[me.api]):this[me.hasChannelWithFeature](e.channels,"door/is-open")?new ge(e,this[me.api]):new se(e,this[me.api]);default:return new se(e,this[me.api])}},t.prototype[me.hasChannelWithFeature]=function(e,t){return Object.keys(e).some(function(n){return e[n].feature===t})},t}(P),Se=Object.freeze({settings:Symbol("settings"),net:Symbol("net"),watchTimer:Symbol("watchTimer"),watchEventBus:Symbol("watchEventBus"),watchGetters:Symbol("watchGetters"),getURL:Symbol("getURL"),onceOnline:Symbol("onceOnline"),onceAuthenticated:Symbol("onceAuthenticated"),onceDocumentVisible:Symbol("onceDocumentVisible"),onceReady:Symbol("onceReady"),fetchGetterValues:Symbol("fetchGetterValues"),updateGetterValue:Symbol("updateGetterValue")}),ke=function(){function e(t,n){r.classCallCheck(this,e),this[Se.net]=t,this[Se.settings]=n,this[Se.watchTimer]=new K(this[Se.settings].watchInterval),this[Se.watchEventBus]=new P,this[Se.watchGetters]=new Map,this[Se.fetchGetterValues]=this[Se.fetchGetterValues].bind(this),Object.freeze(this)}return e.prototype.get=function(e){var t=this;return this[Se.onceReady]().then(function(){return t[Se.net].fetchJSON(t[Se.getURL](e))})},e.prototype.post=function(e,t){var n=this;return this[Se.onceReady]().then(function(){return n[Se.net].fetchJSON(n[Se.getURL](e),"POST",t)})},e.prototype.put=function(e,t){var n=this;return this[Se.onceReady]().then(function(){return n[Se.net].fetchJSON(n[Se.getURL](e),"PUT",t)})},e.prototype["delete"]=function(e,t){var n=this;return this[Se.onceReady]().then(function(){return n[Se.net].fetchJSON(n[Se.getURL](e),"DELETE",t)})},e.prototype.blob=function(e,t){var n=this,r=arguments.length<=2||void 0===arguments[2]?"image/jpeg":arguments[2];return this[Se.onceReady]().then(function(){return t?n[Se.net].fetchBlob(n[Se.getURL](e),r,"PUT",t):n[Se.net].fetchBlob(n[Se.getURL](e),r)})},e.prototype.watch=function(e,t){this[Se.watchEventBus].on(e,t),this[Se.watchGetters].has(e)||(this[Se.watchGetters].set(e,{id:e,value:null}),this[Se.watchTimer].started||this[Se.watchTimer].start(this[Se.fetchGetterValues]))},e.prototype.unwatch=function(e,t){return this[Se.watchGetters].has(e)?(this[Se.watchEventBus].off(e,t),this[Se.watchEventBus].hasListeners(e)||this[Se.watchGetters]["delete"](e),void(0===this[Se.watchGetters].size&&this[Se.watchTimer].stop())):void console.warn('Getter with id "%s" is not watched.',e)},e.prototype[Se.getURL]=function(e){if(!e||"string"!=typeof e)throw new Error("Path should be valid non-empty string.");return`${this[Se.net].origin}/api/v${this[Se.settings].apiVersion}/${e}`},e.prototype[Se.onceReady]=function(){return Promise.all([this[Se.onceOnline](),this[Se.onceAuthenticated](),this[Se.onceDocumentVisible]()])},e.prototype[Se.onceOnline]=function(){var e=this[Se.net];return e.online?Promise.resolve():new Promise(function(t){return e.once("online",function(){return t()})})},e.prototype[Se.onceAuthenticated]=function(){var e=this[Se.settings];return e.session?Promise.resolve():new Promise(function(t){return e.once("session",function(){return t()})})},e.prototype[Se.onceDocumentVisible]=function(){return document.hidden?new Promise(function(e){document.addEventListener("visibilitychange",function t(){document.hidden||(document.removeEventListener("visibilitychange",t),e())})}):Promise.resolve()},e.prototype[Se.fetchGetterValues]=function(){var e=this;if(0===this[Se.watchGetters].size)return Promise.resolve();var t=Array.from(this[Se.watchGetters].values()).map(function(e){var t=e.id;return{id:t}});return this.put("channels/get",t).then(function(t){Object.keys(t).forEach(function(n){var r=e[Se.watchGetters].get(n);r&&e[Se.updateGetterValue](r,t[n])})})},e.prototype[Se.updateGetterValue]=function(e,t){var n=!1;if(t&&e.value){var i=Object.keys(t),o=r.slicedToArray(i,1),s=o[0];if("Error"===s)return void console.error("Failed to retrieve value for getter (%s): %o",e.id,t[s]);var a=t[s],c=e.value[s];n=a&&c&&"object"==typeof a?JSON.stringify(a)!==JSON.stringify(c):a!==c}else n=t!==e.value;n&&(e.value=Object.freeze(t),this[Se.watchEventBus].emit(e.id,e.value))},e}(),xe=Object.freeze({settings:Symbol("settings"),db:Symbol("db"),net:Symbol("net"),boxes:Symbol("boxes"),webPush:Symbol("webPush"),api:Symbol("api")}),we=function(e){function t(){var n=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],i=n.settings,o=n.db,s=n.net;r.classCallCheck(this,t);var a=r.possibleConstructorReturn(this,e.call(this));return a[xe.settings]=i||new U,a[xe.db]=o||new F,a[xe.net]=s||new Q(a[xe.settings]),a[xe.boxes]=Object.freeze([]),a[xe.api]=new ke(a[xe.net],a[xe.settings]),a[xe.webPush]=new re(a[xe.api],a[xe.settings]),a.services=new ye(a[xe.db],a[xe.api],a[xe.settings]),a.recipes=new te(a[xe.api]),Object.seal(a),a}return r.inherits(t,e),t.prototype.init=function(){var e=this;return window.foxbox=this,this[xe.net].on("online",function(t){e._dispatchEvent("online",t)}),this[xe.webPush].on("message",function(t){e._dispatchEvent("push-message",t)}),this._initDiscovery().then(function(){return e[xe.net].init()}),this._initUserSession().then(function(){return e[xe.db].init()})},t.prototype.clear=function(e){var t=[this[xe.settings].clear(),this[xe.db].clear()];return navigator.serviceWorker?(e||t.push(navigator.serviceWorker.ready.then(function(e){return e.unregister()})),Promise.all(t)):Promise.all(t)},t.prototype._initDiscovery=function(){var e=this;return this[xe.settings].skipDiscovery?Promise.resolve():this[xe.net].fetchJSON(this[xe.settings].registrationService).then(function(t){if(!Array.isArray(t))return void console.warn("Got unexpected response from registry server",t);var n=Math.floor(Date.now()/1e3)-120;if(e[xe.boxes]=Object.freeze(t.filter(function(e){return e.timestamp-n>=0}).map(function(e){var t=JSON.parse(e.message),n=t.local_origin,r=t.tunnel_origin,i=e.client;return Object.freeze({local_origin:n,tunnel_origin:r,client:i})})),e._dispatchEvent("discovery"),!e[xe.boxes].length&&!e[xe.settings].localOrigin&&!e[xe.settings].tunnelOrigin)throw new Error("Registration service did not return any boxes.");e[xe.settings].configured||1!==e[xe.boxes].length||e.selectBox()})["catch"](function(t){if(!e[xe.settings].localOrigin&&!e[xe.settings].tunnelOrigin)return console.warn("Retrying box discovery... Reason is %o",t),new Promise(function(t){setTimeout(function(){e._initDiscovery().then(t,t)},1e3)})})},t.prototype.selectBox=function(){var e=arguments.length<=0||void 0===arguments[0]?0:arguments[0];if(!this[xe.boxes].length)return this[xe.settings].configured=!1,void console.error("No boxes found. Is this app online? Is the box online?");if(e>=this[xe.boxes].length)return this[xe.settings].configured=!1,void console.error("Index out of range.");var t=this[xe.boxes][e];this[xe.settings].localOrigin=t.local_origin,t.tunnel_origin?this[xe.settings].tunnelOrigin=t.tunnel_origin:this[xe.settings].tunnelOrigin="",this[xe.settings].client=t.client,this[xe.settings].configured=!0},t.prototype._initUserSession=function(){if(this.isLoggedIn)return Promise.resolve();var e=new URL(location.href),t=new URLSearchParams(e.search.substring(1));return t.has("session_token")?(this[xe.settings].session=t.get("session_token").replace(/ /g,"+"),t["delete"]("session_token"),e.search=t,location.replace(e.href),Promise.reject()):Promise.resolve()},t.prototype.login=function(){if(!this.isLoggedIn){var e=encodeURIComponent(location);location.replace(`${this[xe.net].origin}/?redirect_url=${e}`)}},t.prototype.logout=function(){this[xe.settings].session=null},t.prototype.subscribeToNotifications=function(){var e=!(arguments.length<=0||void 0===arguments[0])&&arguments[0];return this[xe.webPush].subscribeToNotifications(e)},r.createClass(t,[{key:"online",get:function(){return this[xe.net].online}},{key:"client",get:function(){return this[xe.settings].client}},{key:"boxes",get:function(){return this[xe.boxes]}},{key:"isLoggedIn",get:function(){return!!this[xe.settings].session}}]),t}(e.Service),Ce=function(e){function t(){r.classCallCheck(this,t);var n=new we,i=document.querySelector(".app-view-container"),o={foxbox:n,mountNode:i},s=new l(o),a=new E(o),c=r.possibleConstructorReturn(this,e.call(this,{"":s,"users/(.+)":s,services:new d(o),"services/(.+)/tags":new k(o),"services/(.+)":new b(o),themes:a,"themes/(.+)":a,"dev/(.+)/(.+)":new O(o)}));return c.foxbox=n,c}return r.inherits(t,e),t.prototype.main=function(){var e=this;this.foxbox.init().then(function(){e.foxbox.isLoggedIn?(e.foxbox.subscribeToNotifications(),e.foxbox.services.sync(),""===location.hash&&(location.hash="#services"),e.foxbox.addEventListener("push-message",function(e){e.action&&(location.hash=e.action)})):location.hash="#users/login",e.route()})},t}(e.RoutingController),Ee=new Ce;Ee.main()});
//# sourceMappingURL=app.js.map
